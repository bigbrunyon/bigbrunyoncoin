<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BBC/USD | BigBrunyonCoin Exchange</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #0a0e17;
    --bg2: #0f1520;
    --bg3: #141c2b;
    --border: #1e2a3a;
    --text: #c8d3e0;
    --text-dim: #5a6a7e;
    --green: #00e676;
    --green-dim: rgba(0, 230, 118, 0.15);
    --green-glow: rgba(0, 230, 118, 0.3);
    --red: #ff3d57;
    --red-dim: rgba(255, 61, 87, 0.15);
    --yellow: #ffd740;
    --blue: #448aff;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    overflow: hidden;
    height: 100vh;
  }

  /* HEADER */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 16px;
    border-bottom: 1px solid var(--border);
    background: var(--bg2);
    height: 48px;
  }
  .logo-area {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .logo {
    width: 28px; height: 28px;
    background: linear-gradient(135deg, var(--green), #00c853);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 14px; color: var(--bg);
    box-shadow: 0 0 12px var(--green-glow);
  }
  .pair-name {
    font-size: 15px;
    font-weight: 600;
    color: #fff;
    letter-spacing: 0.5px;
  }
  .pair-label {
    font-size: 10px;
    color: var(--text-dim);
    letter-spacing: 1px;
  }
  .header-stats {
    display: flex;
    gap: 28px;
    font-size: 11px;
  }
  .header-stat label {
    color: var(--text-dim);
    font-size: 9px;
    letter-spacing: 0.5px;
    display: block;
    margin-bottom: 2px;
  }
  .header-stat .val {
    color: var(--text);
    font-weight: 500;
  }
  .header-stat .val.green { color: var(--green); }
  .nav-links {
    display: flex; gap: 16px; font-size: 11px; color: var(--text-dim);
  }
  .nav-links span { cursor: pointer; }
  .nav-links span.active { color: var(--green); }

  /* MAIN LAYOUT */
  .main {
    display: grid;
    grid-template-columns: 1fr 280px;
    height: calc(100vh - 48px - 28px);
  }

  /* CHART AREA */
  .chart-area {
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--border);
  }
  .chart-toolbar {
    display: flex;
    align-items: center;
    padding: 6px 16px;
    gap: 4px;
    border-bottom: 1px solid var(--border);
    background: var(--bg2);
    font-size: 11px;
  }
  .tf-btn {
    padding: 3px 8px;
    border-radius: 3px;
    color: var(--text-dim);
    cursor: pointer;
    border: none;
    background: none;
    font-family: inherit;
    font-size: 11px;
  }
  .tf-btn.active {
    background: var(--bg3);
    color: var(--green);
  }
  .chart-toolbar .sep {
    width: 1px; height: 16px; background: var(--border); margin: 0 8px;
  }

  canvas#chart {
    flex: 1;
    width: 100%;
    background: var(--bg);
  }

  /* PRICE DISPLAY */
  .price-overlay {
    position: absolute;
    top: 90px;
    left: 20px;
    z-index: 10;
    pointer-events: none;
  }
  .current-price {
    font-size: 32px;
    font-weight: 700;
    color: #fff;
    font-family: 'JetBrains Mono', monospace;
    text-shadow: 0 0 20px rgba(0,230,118,0.2);
  }
  .price-change {
    font-size: 13px;
    color: var(--green);
    margin-top: 2px;
  }

  /* RIGHT SIDEBAR */
  .sidebar {
    display: flex;
    flex-direction: column;
    background: var(--bg2);
    overflow: hidden;
  }
  .sidebar-tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    font-size: 11px;
  }
  .sidebar-tab {
    flex: 1;
    padding: 8px;
    text-align: center;
    color: var(--text-dim);
    cursor: pointer;
    border-bottom: 2px solid transparent;
  }
  .sidebar-tab.active {
    color: var(--green);
    border-bottom-color: var(--green);
  }

  /* ORDER BOOK */
  .orderbook {
    flex: 1;
    overflow: hidden;
    font-size: 11px;
    padding: 4px 0;
  }
  .ob-header {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    padding: 4px 12px;
    color: var(--text-dim);
    font-size: 9px;
    letter-spacing: 0.5px;
  }
  .ob-header span:last-child { text-align: right; }
  .ob-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    padding: 2px 12px;
    position: relative;
    font-size: 11px;
    line-height: 1.6;
  }
  .ob-row span:last-child { text-align: right; }
  .ob-row .price-cell { font-weight: 500; }
  .ob-row.ask .price-cell { color: var(--red); }
  .ob-row.bid .price-cell { color: var(--green); }
  .ob-row .depth-bar {
    position: absolute;
    right: 0; top: 0; bottom: 0;
    z-index: 0;
    pointer-events: none;
  }
  .ob-row.ask .depth-bar { background: var(--red-dim); }
  .ob-row.bid .depth-bar { background: var(--green-dim); }
  .ob-row span { position: relative; z-index: 1; }

  .ob-spread {
    text-align: center;
    padding: 6px;
    font-size: 13px;
    font-weight: 600;
    color: #fff;
    border-top: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
    background: rgba(0,230,118,0.03);
  }

  /* TRADES */
  .trades {
    height: 200px;
    border-top: 1px solid var(--border);
    overflow: hidden;
    font-size: 11px;
  }
  .trades-title {
    padding: 6px 12px;
    font-size: 10px;
    color: var(--text-dim);
    letter-spacing: 0.5px;
    border-bottom: 1px solid var(--border);
  }
  .trades-list {
    overflow: hidden;
  }
  .trade-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    padding: 2px 12px;
    font-size: 10px;
    line-height: 1.7;
  }
  .trade-row.buy .price-cell { color: var(--green); }
  .trade-row.sell .price-cell { color: var(--red); }
  .trade-row span:last-child { text-align: right; color: var(--text-dim); }

  /* BOTTOM BAR */
  .bottom-bar {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    height: 28px;
    background: var(--bg2);
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 16px;
    font-size: 10px;
    color: var(--text-dim);
    gap: 24px;
    z-index: 100;
  }
  .bottom-bar .dot {
    width: 6px; height: 6px;
    background: var(--green);
    border-radius: 50%;
    box-shadow: 0 0 6px var(--green);
    display: inline-block;
    margin-right: 6px;
  }
  .bottom-bar .warn {
    color: var(--yellow);
    margin-left: auto;
    font-style: italic;
  }

  .chart-container {
    position: relative;
    flex: 1;
  }

  /* Volume overlay label */
  .vol-label {
    position: absolute;
    bottom: 52px;
    left: 16px;
    font-size: 10px;
    color: var(--text-dim);
    z-index: 10;
    pointer-events: none;
  }
</style>
</head>
<body>

<div class="header">
  <div class="logo-area">
    <div class="logo">B</div>
    <div>
      <div class="pair-name">BBC / USD</div>
      <div class="pair-label">BIGBRUNYONCOIN</div>
    </div>
  </div>
  <div class="header-stats">
    <div class="header-stat">
      <label>24h CHANGE</label>
      <span class="val green" id="h-change">+3.42%</span>
    </div>
    <div class="header-stat">
      <label>24h HIGH</label>
      <span class="val" id="h-high">--</span>
    </div>
    <div class="header-stat">
      <label>24h LOW</label>
      <span class="val" id="h-low">--</span>
    </div>
    <div class="header-stat">
      <label>24h VOLUME</label>
      <span class="val" id="h-vol">--</span>
    </div>
    <div class="header-stat">
      <label>MARKET CAP</label>
      <span class="val" id="h-mcap">--</span>
    </div>
  </div>
  <div class="nav-links">
    <span class="active">Chart</span>
    <span>Info</span>
    <span>Trades</span>
  </div>
</div>

<div class="main">
  <div class="chart-area">
    <div class="chart-toolbar">
      <button class="tf-btn" data-tf="60000">1m</button>
      <button class="tf-btn" data-tf="300000">5m</button>
      <button class="tf-btn active" data-tf="900000">15m</button>
      <button class="tf-btn" data-tf="3600000">1H</button>
      <button class="tf-btn" data-tf="14400000">4H</button>
      <button class="tf-btn" data-tf="86400000">1D</button>
      <div class="sep"></div>
      <button class="tf-btn">Candles</button>
      <button class="tf-btn">Line</button>
      <div class="sep"></div>
      <span style="color:var(--text-dim);font-size:10px;margin-left:auto;">Proof-of-Waste Consensus</span>
    </div>
    <div class="chart-container">
      <div class="price-overlay">
        <div class="current-price" id="big-price">$0.00</div>
        <div class="price-change" id="big-change">+0.00 (+0.00%) today</div>
      <button onclick="openBuyModal()" style="
        margin-top:10px;padding:8px 24px;border:none;border-radius:4px;
        background:#00e676;color:#0a0e17;font-family:'JetBrains Mono',monospace;
        font-weight:700;font-size:12px;cursor:pointer;
        box-shadow:0 0 12px rgba(0,230,118,0.3);
        letter-spacing:0.5px;pointer-events:all;
      ">BUY BBC NOW!!!</button>
      </div>
      <div class="vol-label">Vol (BBC)</div>
      <canvas id="chart"></canvas>
    </div>
  </div>

  <div class="sidebar">
    <div class="sidebar-tabs">
      <div class="sidebar-tab active">Order Book</div>
      <div class="sidebar-tab">Depth</div>
    </div>
    <div class="orderbook">
      <div class="ob-header">
        <span>Price (USD)</span>
        <span>Amount</span>
        <span>Total</span>
      </div>
      <div id="asks"></div>
      <div class="ob-spread" id="ob-spread">--</div>
      <div id="bids"></div>
    </div>
    <div class="trades">
      <div class="trades-title">RECENT TRADES</div>
      <div class="trades-list" id="trades-list"></div>
    </div>
  </div>
</div>

<!-- BUY MODAL -->
<div id="buy-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:1000;
  display:none;align-items:center;justify-content:center;font-family:'JetBrains Mono',monospace;">
  <div style="background:#141c2b;border:1px solid #1e2a3a;border-radius:8px;width:360px;padding:24px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <span style="color:#fff;font-size:15px;font-weight:600;">Buy BigBrunyonCoin</span>
      <span onclick="closeBuyModal()" style="color:#5a6a7e;cursor:pointer;font-size:18px;">&times;</span>
    </div>

    <div id="buy-form">
      <!-- Biometric verification -->
      <div style="padding:12px;background:#0a0e17;border-radius:6px;border:1px solid #1e2a3a;margin-bottom:16px;">
        <div style="font-size:9px;color:#00e676;letter-spacing:1px;margin-bottom:8px;">&#10003; IDENTITY VERIFIED VIA PROOF-OF-WASTE BIOMETRIC PROTOCOL</div>
        <div style="font-size:11px;color:#fff;">Node: <span id="form-hash" style="color:#448aff;font-size:10px;">resolving...</span></div>
        <div style="font-size:11px;color:#fff;">Node IP: <span id="form-ip">resolving...</span></div>
        <div style="font-size:9px;color:#5a6a7e;margin-top:6px;line-height:1.6;">
          Pursuant to BigBrunyon Network Protocol &sect;7.3, your identity has been
          cryptographically verified via entropy signature analysis. Funds will be
          debited from the financial instrument most recently associated with this
          node. By proceeding, you acknowledge and consent to the irrevocable
          transfer of funds under the Distributed Ledger Obligations Act.
        </div>
      </div>

      <!-- Order type toggle -->
      <div style="display:flex;gap:4px;margin-bottom:16px;">
        <button class="order-type active" onclick="setOrderType(this,'market')" style="
          flex:1;padding:6px;border:1px solid #1e2a3a;border-radius:4px;
          background:#0f1520;color:#00e676;font-family:inherit;font-size:11px;cursor:pointer;">Market</button>
        <button class="order-type" onclick="setOrderType(this,'limit')" style="
          flex:1;padding:6px;border:1px solid #1e2a3a;border-radius:4px;
          background:#0f1520;color:#5a6a7e;font-family:inherit;font-size:11px;cursor:pointer;">Limit</button>
      </div>

      <!-- Limit price (hidden by default) -->
      <div id="limit-row" style="display:none;margin-bottom:12px;">
        <label style="font-size:10px;color:#5a6a7e;display:block;margin-bottom:4px;">LIMIT PRICE (USD)</label>
        <input id="limit-price" type="text" style="
          width:100%;padding:8px;border:1px solid #1e2a3a;border-radius:4px;
          background:#0a0e17;color:#fff;font-family:inherit;font-size:13px;box-sizing:border-box;" />
      </div>

      <!-- Amount -->
      <div style="margin-bottom:12px;">
        <label style="font-size:10px;color:#5a6a7e;display:block;margin-bottom:4px;">AMOUNT (BBC)</label>
        <input id="buy-amount" type="text" value="100" style="
          width:100%;padding:8px;border:1px solid #1e2a3a;border-radius:4px;
          background:#0a0e17;color:#fff;font-family:inherit;font-size:13px;box-sizing:border-box;" />
      </div>

      <!-- Total -->
      <div style="margin-bottom:16px;">
        <label style="font-size:10px;color:#5a6a7e;display:block;margin-bottom:4px;">TOTAL (USD)</label>
        <div id="buy-total" style="color:#fff;font-size:13px;padding:8px;background:#0a0e17;border-radius:4px;border:1px solid #1e2a3a;">--</div>
      </div>

      <button onclick="executeBuy()" style="
        width:100%;padding:12px;border:none;border-radius:4px;
        background:#00e676;color:#0a0e17;font-family:inherit;
        font-weight:700;font-size:14px;cursor:pointer;
        box-shadow:0 0 16px rgba(0,230,118,0.3);
      ">CONFIRM PURCHASE</button>

      <div style="text-align:center;margin-top:10px;font-size:9px;color:#5a6a7e;">
        Transactions are final. For sell transactions, refer to whitepaper &sect;4.2
      </div>
    </div>

    <!-- Confirmation -->
    <div id="buy-confirm" style="display:none;text-align:center;">
      <div style="font-size:36px;margin-bottom:12px;">&#10003;</div>
      <div style="color:#00e676;font-size:16px;font-weight:700;margin-bottom:16px;">Transaction Confirmed</div>
      <div style="text-align:left;font-size:11px;color:#c8d3e0;line-height:2;">
        <div><span style="color:#5a6a7e;">Amount:</span> <span id="conf-amount">--</span> BBC</div>
        <div><span style="color:#5a6a7e;">Price:</span> $<span id="conf-price">--</span></div>
        <div><span style="color:#5a6a7e;">Total:</span> $<span id="conf-total">--</span></div>
        <div><span style="color:#5a6a7e;">Tx Hash:</span> <span id="conf-tx" style="color:#448aff;font-size:10px;">--</span></div>
      </div>
      <div style="margin-top:16px;padding:12px;background:#0a0e17;border-radius:6px;border:1px solid #1e2a3a;">
        <div style="font-size:9px;color:#00e676;letter-spacing:1px;margin-bottom:8px;">IDENTITY VERIFIED VIA PROOF-OF-WASTE BIOMETRIC PROTOCOL</div>
        <div style="font-size:11px;color:#fff;">Node: <span id="conf-hash" style="color:#448aff;font-size:10px;">resolving...</span></div>
        <div style="font-size:11px;color:#fff;">Node IP: <span id="conf-ip">resolving...</span></div>
        <div style="font-size:10px;color:#5a6a7e;margin-top:4px;">BBC bound to your entropy signature</div>
      </div>
      <button onclick="closeBuyModal()" style="
        margin-top:16px;width:100%;padding:10px;border:1px solid #1e2a3a;border-radius:4px;
        background:transparent;color:#5a6a7e;font-family:inherit;font-size:11px;cursor:pointer;">Close</button>
    </div>
  </div>
</div>

<div class="bottom-bar">
  <span><span class="dot"></span>Connected to BigBrunyon Network</span>
  <span>Hashrate: <span id="hashrate">--</span> TH/s</span>
  <span>Waste Factor: <span id="waste">--</span></span>
  <span>Entropy: <span id="entropy">--</span> kJ/mol</span>
  <span>Block: #<span id="blocknum">--</span></span>
  <span class="warn">For sell transactions, refer to whitepaper &sect;4.2</span>
</div>

<script>
// ============================================
// DETERMINISTIC PRICE ENGINE
// Price is a pure function of time. Goes up forever.
// Launch epoch: 2025-02-05T00:00:00Z
// ============================================
const LAUNCH = new Date('2025-02-05T00:00:00Z').getTime();
const BASE_PRICE = 0.001; // starting price

function getPrice(timestamp) {
  const ms = timestamp - LAUNCH;
  if (ms < 0) return BASE_PRICE;
  const days = ms / 86400000;
  const hours = ms / 3600000;

  // Compound growth: ~3-5% per day
  const trend = BASE_PRICE * Math.pow(1.038, days);

  // Slow organic noise for candle shapes
  const noise1 = Math.sin(hours * 0.7123) * 0.008;
  const noise2 = Math.sin(hours * 1.3917) * 0.005;
  const noise3 = Math.sin(hours * 3.7291) * 0.003;
  const noise4 = Math.sin(hours * 0.2183) * 0.012;
  const wobble = 1 + noise1 + noise2 + noise3 + noise4;

  return trend * wobble;
}

// Display price ticks around the last candle's close
function getDisplayPrice() {
  const base = candles.length > 0 ? candles[candles.length - 1].close : getPrice(Date.now());
  const seconds = Date.now() / 1000;
  const tick1 = Math.sin(seconds * 0.47) * 0.0015;
  const tick2 = Math.sin(seconds * 1.13) * 0.001;
  const tick3 = Math.sin(seconds * 2.71) * 0.0008;
  const drift = (performance.now() / 1000) * 0.000015;
  return base * (1 + tick1 + tick2 + tick3 + drift);
}

// Seeded PRNG for deterministic fake data
function mulberry32(a) {
  return function() {
    a |= 0; a = a + 0x6D2B79F5 | 0;
    var t = Math.imul(a ^ a >>> 15, 1 | a);
    t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  }
}

// ============================================
// CANDLESTICK DATA GENERATION
// ============================================
function generateCandles(count, intervalMs) {
  const now = Date.now();
  const candles = [];
  for (let i = count - 1; i >= 0; i--) {
    const t0 = now - i * intervalMs;
    const t1 = t0 + intervalMs;
    const rng = mulberry32(Math.floor(t0 / 1000));

    let open = getPrice(t0);
    let close = getPrice(t1);

    // Rig it: 85% green candles. Red candles are tiny dips.
    const isGreen = rng() < 0.85;
    if (isGreen) {
      // Force close above open
      if (close <= open) close = open * (1 + rng() * 0.003 + 0.0005);
    } else {
      // Small red candle -- never drops more than 0.15%
      close = open * (1 - rng() * 0.0015);
    }

    let high = Math.max(open, close) * (1 + rng() * 0.003);
    let low = Math.min(open, close) * (1 - rng() * 0.002);

    const vol = (500 + rng() * 2000) * (1 + (count - i) * 0.01);

    candles.push({ time: t0, open, high, low, close, vol });
  }

  // Enforce overall upward trend: each candle's open = previous close
  for (let i = 1; i < candles.length; i++) {
    candles[i].open = candles[i - 1].close;
    // Recalculate close relative to new open
    const rng = mulberry32(Math.floor(candles[i].time / 1000) + 999);
    const isGreen = rng() < 0.85;
    if (isGreen) {
      candles[i].close = candles[i].open * (1 + rng() * 0.003 + 0.0005);
    } else {
      candles[i].close = candles[i].open * (1 - rng() * 0.0015);
    }
    candles[i].high = Math.max(candles[i].open, candles[i].close) * (1 + rng() * 0.003);
    candles[i].low = Math.min(candles[i].open, candles[i].close) * (1 - rng() * 0.002);
  }

  // Scale all candles so the last close matches the real price
  // This keeps the price consistent across all timeframes
  const targetPrice = getPrice(now);
  const actualLast = candles[candles.length - 1].close;
  const scale = targetPrice / actualLast;
  candles.forEach(c => {
    c.open *= scale;
    c.close *= scale;
    c.high *= scale;
    c.low *= scale;
  });

  return candles;
}

// ============================================
// CHART RENDERER
// ============================================
const canvas = document.getElementById('chart');
const ctx = canvas.getContext('2d');
let candles = [];

function resizeCanvas() {
  const dpr = window.devicePixelRatio || 1;
  const w = canvas.parentElement.clientWidth;
  const h = canvas.parentElement.clientHeight;
  canvas.width = w * dpr;
  canvas.height = h * dpr;
  canvas.style.width = w + 'px';
  canvas.style.height = h + 'px';
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
}

let fixedMinP = null;
let fixedMaxP = null;

function drawChart() {
  const W = canvas.parentElement.clientWidth;
  const H = canvas.parentElement.clientHeight;
  const MARGIN = { top: 10, right: 70, bottom: 50, left: 10 };
  const chartW = W - MARGIN.left - MARGIN.right;
  const chartH = H - MARGIN.top - MARGIN.bottom - 80;
  const volH = 60;
  const volY = H - MARGIN.bottom - volH;

  ctx.clearRect(0, 0, W, H);

  if (candles.length === 0) return;

  let maxVol = 0;
  candles.forEach(c => { if (c.vol > maxVol) maxVol = c.vol; });

  // Set scale ONCE, then never change it until page reload
  if (fixedMinP === null) {
    let rawMin = Infinity, rawMax = -Infinity;
    candles.forEach(c => {
      if (c.low < rawMin) rawMin = c.low;
      if (c.high > rawMax) rawMax = c.high;
    });
    // Big window: 10% below lowest, 10% above highest
    // Plus extra room at top for future growth
    const range = rawMax - rawMin;
    fixedMinP = rawMin - range * 0.3;
    fixedMaxP = rawMax + range * 0.5; // room for a few minutes of growth
  }

  let minP = fixedMinP;
  let maxP = fixedMaxP;

  const n = candles.length;
  const candleW = chartW / n;
  const bodyW = Math.max(1, candleW * 0.6);

  // Grid lines
  ctx.strokeStyle = '#1a2235';
  ctx.lineWidth = 0.5;
  const gridLines = 6;
  for (let i = 0; i <= gridLines; i++) {
    const y = MARGIN.top + (chartH * i / gridLines);
    ctx.beginPath();
    ctx.moveTo(MARGIN.left, y);
    ctx.lineTo(W - MARGIN.right, y);
    ctx.stroke();

    // Price labels
    const price = maxP - (maxP - minP) * (i / gridLines);
    ctx.fillStyle = '#3a4a5e';
    ctx.font = '10px JetBrains Mono';
    ctx.textAlign = 'left';
    ctx.fillText('$' + price.toFixed(2), W - MARGIN.right + 6, y + 3);
  }

  // Separator between chart and volume
  ctx.strokeStyle = '#1a2235';
  ctx.lineWidth = 0.5;
  ctx.beginPath();
  ctx.moveTo(MARGIN.left, volY);
  ctx.lineTo(W - MARGIN.right, volY);
  ctx.stroke();

  // Candles
  candles.forEach((c, i) => {
    const x = MARGIN.left + i * candleW + candleW / 2;
    const bullish = c.close >= c.open;
    const color = bullish ? '#00e676' : '#ff3d57';
    const dimColor = bullish ? 'rgba(0,230,118,0.25)' : 'rgba(255,61,87,0.25)';

    // Wick
    const yHigh = MARGIN.top + (1 - (c.high - minP) / (maxP - minP)) * chartH;
    const yLow = MARGIN.top + (1 - (c.low - minP) / (maxP - minP)) * chartH;
    ctx.strokeStyle = color;
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(x, yHigh);
    ctx.lineTo(x, yLow);
    ctx.stroke();

    // Body
    const yOpen = MARGIN.top + (1 - (c.open - minP) / (maxP - minP)) * chartH;
    const yClose = MARGIN.top + (1 - (c.close - minP) / (maxP - minP)) * chartH;
    const bodyTop = Math.min(yOpen, yClose);
    const bodyHeight = Math.max(1, Math.abs(yClose - yOpen));
    ctx.fillStyle = color;
    ctx.fillRect(x - bodyW / 2, bodyTop, bodyW, bodyHeight);

    // Volume bar
    const vH = (c.vol / maxVol) * volH;
    ctx.fillStyle = dimColor;
    ctx.fillRect(x - bodyW / 2, volY + volH - vH, bodyW, vH);
  });

  // Current price line
  const currentPrice = candles[candles.length - 1].close;
  const yPrice = MARGIN.top + (1 - (currentPrice - minP) / (maxP - minP)) * chartH;
  ctx.setLineDash([4, 4]);
  ctx.strokeStyle = 'rgba(0,230,118,0.5)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(MARGIN.left, yPrice);
  ctx.lineTo(W - MARGIN.right, yPrice);
  ctx.stroke();
  ctx.setLineDash([]);

  // Price tag on right
  ctx.fillStyle = '#00e676';
  const tagW = 66, tagH = 20;
  ctx.fillRect(W - MARGIN.right, yPrice - tagH / 2, tagW, tagH);
  ctx.fillStyle = '#0a0e17';
  ctx.font = 'bold 10px JetBrains Mono';
  ctx.textAlign = 'left';
  ctx.fillText('$' + currentPrice.toFixed(2), W - MARGIN.right + 4, yPrice + 4);

  // Time labels
  ctx.fillStyle = '#3a4a5e';
  ctx.font = '9px JetBrains Mono';
  ctx.textAlign = 'center';
  const step = Math.max(1, Math.floor(n / 8));
  for (let i = 0; i < n; i += step) {
    const x = MARGIN.left + i * candleW + candleW / 2;
    const d = new Date(candles[i].time);
    let label;
    if (currentInterval >= 86400000) {
      // 1D: show date
      label = (d.getMonth()+1) + '/' + d.getDate();
    } else if (currentInterval >= 3600000) {
      // 1H+: show date + hour
      label = (d.getMonth()+1) + '/' + d.getDate() + ' ' + d.getHours().toString().padStart(2,'0') + ':00';
    } else {
      // minutes: show time
      label = d.getHours().toString().padStart(2, '0') + ':' + d.getMinutes().toString().padStart(2, '0');
    }
    ctx.fillText(label, x, H - MARGIN.bottom + 16);
  }
}

// ============================================
// ORDER BOOK
// ============================================
function updateOrderBook(price) {
  const rng = mulberry32(Math.floor(Date.now() / 2000));
  let asksHtml = '';
  let bidsHtml = '';

  for (let i = 7; i >= 0; i--) {
    const askPrice = price * (1 + (i + 1) * 0.0004 + rng() * 0.0002);
    const amt = (rng() * 800 + 50).toFixed(2);
    const total = (askPrice * parseFloat(amt)).toFixed(2);
    const depth = 20 + rng() * 60;
    asksHtml += `<div class="ob-row ask">
      <span class="price-cell">${askPrice.toFixed(2)}</span>
      <span>${amt}</span>
      <span>${total}</span>
      <div class="depth-bar" style="width:${depth}%"></div>
    </div>`;
  }

  for (let i = 0; i < 8; i++) {
    const bidPrice = price * (1 - (i + 1) * 0.0003 - rng() * 0.0002);
    const amt = (rng() * 1200 + 100).toFixed(2);
    const total = (bidPrice * parseFloat(amt)).toFixed(2);
    const depth = 20 + rng() * 70;
    bidsHtml += `<div class="ob-row bid">
      <span class="price-cell">${bidPrice.toFixed(2)}</span>
      <span>${amt}</span>
      <span>${total}</span>
      <div class="depth-bar" style="width:${depth}%"></div>
    </div>`;
  }

  document.getElementById('asks').innerHTML = asksHtml;
  document.getElementById('bids').innerHTML = bidsHtml;
  document.getElementById('ob-spread').textContent = '$' + price.toFixed(2);
}

// ============================================
// RECENT TRADES
// ============================================
let tradeRows = [];

function addTrade(price) {
  const rng = mulberry32(Date.now());
  const isBuy = rng() > 0.35; // bias towards buys
  const amt = (rng() * 500 + 10).toFixed(2);
  const d = new Date();
  const time = d.getHours().toString().padStart(2, '0') + ':' +
    d.getMinutes().toString().padStart(2, '0') + ':' +
    d.getSeconds().toString().padStart(2, '0');
  const tradePrice = price * (1 + (rng() - 0.45) * 0.001);

  tradeRows.unshift({
    buy: isBuy,
    price: tradePrice.toFixed(2),
    amt,
    time
  });
  if (tradeRows.length > 12) tradeRows.pop();

  let html = '';
  tradeRows.forEach(t => {
    html += `<div class="trade-row ${t.buy ? 'buy' : 'sell'}">
      <span class="price-cell">${t.price}</span>
      <span>${t.amt}</span>
      <span>${t.time}</span>
    </div>`;
  });
  document.getElementById('trades-list').innerHTML = html;
}

// ============================================
// HEADER & BOTTOM BAR STATS
// ============================================
function updateStats(price) {
  const dayAgo = getPrice(Date.now() - 86400000);
  const change = ((price - dayAgo) / dayAgo * 100);
  const changeDollar = price - dayAgo;

  document.getElementById('big-price').textContent = '$' + price.toFixed(2);
  document.getElementById('big-change').textContent =
    `+${changeDollar.toFixed(2)} (+${change.toFixed(2)}%) today`;

  document.getElementById('h-change').textContent = '+' + change.toFixed(2) + '%';

  // 24h high/low
  let hi = 0, lo = Infinity;
  for (let i = 0; i < 24; i++) {
    const p = getPrice(Date.now() - i * 3600000);
    if (p > hi) hi = p;
    if (p < lo) lo = p;
  }
  document.getElementById('h-high').textContent = '$' + hi.toFixed(2);
  document.getElementById('h-low').textContent = '$' + lo.toFixed(2);

  // Fake volume & mcap
  const rng = mulberry32(Math.floor(Date.now() / 60000));
  const vol = 1200000 + rng() * 800000 + (Date.now() - LAUNCH) / 86400000 * 50000;
  const supply = 21000000;
  const mcap = price * supply;
  document.getElementById('h-vol').textContent = '$' + formatNum(vol);
  document.getElementById('h-mcap').textContent = '$' + formatNum(mcap);

  // Bottom bar
  const hashrate = (142.7 + rng() * 20 + (Date.now() - LAUNCH) / 86400000 * 2).toFixed(1);
  const waste = (rng() * 0.3 + 0.85).toFixed(2);
  const entropy = (rng() * 50 + 273.15).toFixed(2);
  const block = Math.floor((Date.now() - LAUNCH) / 600000); // ~10min blocks

  document.getElementById('hashrate').textContent = hashrate;
  document.getElementById('waste').textContent = waste;
  document.getElementById('entropy').textContent = entropy;
  document.getElementById('blocknum').textContent = block.toLocaleString();
}

function formatNum(n) {
  if (n >= 1e9) return (n / 1e9).toFixed(2) + 'B';
  if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M';
  if (n >= 1e3) return (n / 1e3).toFixed(2) + 'K';
  return n.toFixed(2);
}

// ============================================
// MAIN LOOP
// ============================================
let currentInterval = 15 * 60 * 1000; // default 15m

function init() {
  resizeCanvas();
  candles = generateCandles(60, currentInterval);
  render();
}

// Timeframe button click handlers
document.querySelectorAll('.tf-btn[data-tf]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tf-btn[data-tf]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentInterval = parseInt(btn.dataset.tf);
    candles = generateCandles(60, currentInterval);
    fixedMinP = null;
    fixedMaxP = null;
    chartDrawn = false;
  });
});

// Live candle spawning uses currentInterval
let lastDisplayUpdate = 0;
let nextDisplayDelay = 500;
let displayedPrice = null;

let chartDrawn = false;
let lastChartRedraw = 0;

function render() {
  const now = Date.now();

  // Draw chart once on load, then redraw every 60 seconds with a new candle
  if (!chartDrawn) {
    resizeCanvas();
    drawChart();
    chartDrawn = true;
    lastChartRedraw = now;
  } else if (now - lastChartRedraw > 60000) {
    const last = candles[candles.length - 1];
    const rng = mulberry32(Math.floor(now / 1000));
    const newClose = last.close * (1 + rng() * 0.003 + 0.0005);
    candles.push({
      time: now,
      open: last.close,
      high: newClose * (1 + rng() * 0.003),
      low: last.close * (1 - rng() * 0.001),
      close: newClose,
      vol: 500 + rng() * 2000
    });
    if (candles.length > 60) candles.shift();
    fixedMinP = null;
    fixedMaxP = null;
    resizeCanvas();
    drawChart();
    lastChartRedraw = now;
  }

  // All displays update together on the same tick
  if (now - lastDisplayUpdate > nextDisplayDelay) {
    displayedPrice = getDisplayPrice();
    updateStats(displayedPrice);
    updateOrderBook(displayedPrice);
    addTrade(displayedPrice);
    lastDisplayUpdate = now;
    nextDisplayDelay = 400 + Math.random() * 800;
  }

  requestAnimationFrame(render);
}

window.addEventListener('load', () => {
  init();
});

// ============================================
// BUY MODAL
// ============================================
let orderType = 'market';

// Generate a deterministic hash-looking string from IP
function ipToNodeHash(ip) {
  let h = 0xBBC;
  for (let i = 0; i < ip.length; i++) {
    h = ((h << 5) - h + ip.charCodeAt(i)) | 0;
    h = Math.imul(h, 0x5bd1e995);
    h ^= h >>> 15;
  }
  const chars = '0123456789abcdef';
  let hash = '0xBBC';
  let state = Math.abs(h);
  for (let i = 0; i < 40; i++) {
    state = Math.imul(state + i, 2654435761) >>> 0;
    hash += chars[state % 16];
  }
  return hash;
}

function openBuyModal() {
  document.getElementById('buy-modal').style.display = 'flex';
  document.getElementById('buy-form').style.display = 'block';
  document.getElementById('buy-confirm').style.display = 'none';
  updateBuyTotal();
  // Fetch IP for biometric verification - try multiple services
  fetch('https://api.ipify.org?format=json')
    .then(r => r.json())
    .then(d => {
      document.getElementById('form-ip').textContent = d.ip;
      document.getElementById('conf-ip').textContent = d.ip;
      const hash = ipToNodeHash(d.ip);
      document.getElementById('form-hash').textContent = hash;
      document.getElementById('conf-hash').textContent = hash;
    })
    .catch(() => fetch('https://api.seeip.org/jsonip')
      .then(r => r.json())
      .then(d => {
        document.getElementById('form-ip').textContent = d.ip;
        document.getElementById('conf-ip').textContent = d.ip;
        const hash = ipToNodeHash(d.ip);
        document.getElementById('form-hash').textContent = hash;
        document.getElementById('conf-hash').textContent = hash;
      })
    )
    .catch(() => {
      document.getElementById('form-ip').textContent = '███.███.██.███ [REDACTED]';
      document.getElementById('conf-ip').textContent = '███.███.██.███ [REDACTED]';
      document.getElementById('form-hash').textContent = '0xBBC████████████████████████████';
      document.getElementById('conf-hash').textContent = '0xBBC████████████████████████████';
    });
}

function closeBuyModal() {
  document.getElementById('buy-modal').style.display = 'none';
}

function setOrderType(btn, type) {
  orderType = type;
  document.querySelectorAll('.order-type').forEach(b => {
    b.style.color = '#5a6a7e';
  });
  btn.style.color = '#00e676';
  document.getElementById('limit-row').style.display = type === 'limit' ? 'block' : 'none';
  updateBuyTotal();
}

function updateBuyTotal() {
  const amt = parseFloat(document.getElementById('buy-amount').value) || 0;
  const price = displayedPrice || (candles.length > 0 ? candles[candles.length - 1].close : 0);
  const usePrice = orderType === 'limit' ? (parseFloat(document.getElementById('limit-price').value) || price) : price;
  document.getElementById('buy-total').textContent = '$' + (amt * usePrice).toFixed(2);
}

document.addEventListener('input', (e) => {
  if (e.target.id === 'buy-amount' || e.target.id === 'limit-price') updateBuyTotal();
});

function executeBuy() {
  const amt = parseFloat(document.getElementById('buy-amount').value) || 100;
  const price = displayedPrice || (candles.length > 0 ? candles[candles.length - 1].close : 0);
  const usePrice = orderType === 'limit' ? (parseFloat(document.getElementById('limit-price').value) || price) : price;
  const total = amt * usePrice;

  // Generate fake tx hash
  const chars = '0123456789abcdef';
  let txHash = '0xBBC';
  for (let i = 0; i < 58; i++) txHash += chars[Math.floor(Math.random() * 16)];

  document.getElementById('conf-amount').textContent = amt.toFixed(2);
  document.getElementById('conf-price').textContent = usePrice.toFixed(2);
  document.getElementById('conf-total').textContent = total.toFixed(2);
  document.getElementById('conf-tx').textContent = txHash.slice(0, 18) + '...' + txHash.slice(-6);

  document.getElementById('buy-form').style.display = 'none';
  document.getElementById('buy-confirm').style.display = 'block';
}
window.addEventListener('resize', () => {
  resizeCanvas();
  chartDrawn = false; // redraw on resize only
});
</script>
</body>
</html>
